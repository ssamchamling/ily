<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura of Love | Digital Union</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,600;1,400&family=Monsieur+La+Doulaise&family=Montserrat:wght@300;400&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --pink: #fdf2f4; --rose: #9d4658; --gold: #c5a059; --white: #ffffff; }
        
        body { background-color: var(--pink); font-family: 'Montserrat', sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }

        .page { display: none; width: 90%; max-width: 500px; background: var(--white); padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 15px 50px rgba(157, 70, 88, 0.1); box-sizing: border-box; }
        .active { display: block !important; animation: slideUp 0.6s ease-out; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-family: 'Monsieur La Doulaise', cursive; font-size: 3.5rem; color: var(--rose); margin: 0; }
        h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.4rem; color: var(--gold); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 20px; }
        
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #f0f0f0; border-radius: 10px; box-sizing: border-box; background: #fafafa; font-family: inherit; }

        .btn { background: var(--rose); color: white; border: none; padding: 16px 30px; border-radius: 50px; cursor: pointer; width: 100%; font-weight: 600; margin-top: 10px; transition: 0.3s; }
        .btn:hover { background: var(--gold); }

        .upload-section { text-align: left; margin-top: 15px; }
        .upload-label { font-size: 0.7rem; font-weight: bold; color: var(--rose); display: block; margin-bottom: 5px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }

        /* Certificate Styling - Matches your screenshot */
        #cert-wrap { width: 800px; height: 600px; background: #fffcf9; border: 12px double var(--gold); padding: 20px; display: none; position: absolute; left: -9999px; box-sizing: border-box; }
        .cert-inner { border: 1px solid var(--gold); height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 40px; box-sizing: border-box; position: relative; }
        
        .cert-main-row { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-top: 20px; }
        .frame { width: 160px; height: 160px; border-radius: 50%; background: #e0e0e0; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .frame img { width: 100%; height: 100%; object-fit: cover; }

        .cert-text { text-align: center; flex: 1; padding: 0 20px; }
        .cert-text p { font-size: 0.9rem; line-height: 1.5; color: #444; }

        .sig-container { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; padding: 0 20px; }
        .sig-box { text-align: center; width: 200px; }
        .sig-box img { max-width: 150px; max-height: 60px; filter: grayscale(1) contrast(1.2); mix-blend-mode: multiply; }
        .sig-line { border-top: 1px solid #ccc; margin-top: 5px; font-size: 0.65rem; color: #888; text-transform: uppercase; }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <h1>Creating Magic...</h1>
        <p>Preparing your certificate</p>
    </div>

    <div id="p1" class="page active">
        <h1>Welcome</h1>
        <h2>Aura of Love</h2>
        <button class="btn" onclick="showPage('p2')">Start Journey</button>
    </div>

    <div id="p2" class="page">
        <h2>The Couple</h2>
        <input type="text" id="name1" placeholder="Your Full Name">
        <input type="text" id="name2" placeholder="Partner's Full Name">
        <input type="email" id="myEmail" placeholder="Your Email (for notification)">
        
        <div class="upload-section">
            <span class="upload-label">Profile Photos</span>
            <div class="grid-2">
                <input type="file" accept="image/*" onchange="preview(this, 'v1')">
                <input type="file" accept="image/*" onchange="preview(this, 'v2')">
            </div>
            <span class="upload-label">Paper Signatures</span>
            <div class="grid-2">
                <input type="file" accept="image/*" onchange="preview(this, 'sig1')">
                <input type="file" accept="image/*" onchange="preview(this, 'sig2')">
            </div>
        </div>
        <button class="btn" onclick="showPage('p3')">Next</button>
    </div>

    <div id="p3" class="page">
        <h2>Your Vows</h2>
        <textarea id="proposalMsg" rows="6" placeholder="Your message of love..."></textarea>
        <button class="btn" onclick="showPage('p4')">Next</button>
    </div>

    <div id="p4" class="page">
        <h2>Send Proposal</h2>
        <input type="email" id="email2" placeholder="Partner's Email Address">
        <button class="btn" onclick="sendProposal()">Send Proposal</button>
    </div>

    <div id="p-waiting" class="page">
        <h1>Sent! ❤️</h1>
        <p>Waiting for partner to accept...</p>
    </div>

    <div id="p5" class="page">
        <h1 id="partner-heading">For You</h1>
        <p id="proposal-display" style="background: #fffcf9; padding: 15px; border-radius: 10px; border: 1px solid var(--pink); font-size: 0.85rem;"></p>
        <textarea id="vows" rows="4" placeholder="Your response/vows..."></textarea>
        <button class="btn" onclick="partnerAccepts()">Accept Proposal ❤️</button>
    </div>

    <div id="p6" class="page">
        <h1>Official!</h1>
        <p>Your certificate is ready for download.</p>
        <button class="btn" onclick="download()">Download PNG Certificate</button>
    </div>

    <div id="cert-wrap">
        <div class="cert-inner">
            <div style="text-align: center;">
                <p style="letter-spacing: 5px; color: var(--gold); font-size: 0.75rem; margin: 0;">ESTABLISHED IN LOVE</p>
                <h1 style="font-size: 3.5rem; margin: 10px 0; font-family: 'Monsieur La Doulaise', cursive;">Marriage License</h1>
            </div>

            <div class="cert-main-row">
                <div class="frame"><img id="v1" src=""></div>
                <div class="cert-text">
                    <h2 id="final-names" style="font-size: 2.2rem; color: #333; margin-bottom: 15px;"></h2>
                    <p id="final-vows"></p>
                </div>
                <div class="frame"><img id="v2" src=""></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <div style="font-family: 'Monsieur La Doulaise', cursive; font-size: 2.5rem; color: var(--rose);">Infinite Love</div>
            </div>

            <div class="sig-container">
                <div class="sig-box">
                    <img id="sig1" src="">
                    <div class="sig-line" id="sig-label-1">Signature</div>
                </div>
                <div class="sig-box">
                    <img id="sig2" src="">
                    <div class="sig-line" id="sig-label-2">Signature</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        emailjs.init("6Esqq34VB6yAXZCB3");

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function preview(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.onload = () => console.log(imgId + " loaded");
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function sendProposal() {
            const n1 = document.getElementById('name1').value;
            const n2 = document.getElementById('name2').value;
            const myEmail = document.getElementById('myEmail').value;
            const msg = document.getElementById('proposalMsg').value;
            const email2 = document.getElementById('email2').value;
            const pLink = `${window.location.origin}${window.location.pathname}?partner=true&n1=${encodeURIComponent(n1)}&n2=${encodeURIComponent(n2)}&msg=${encodeURIComponent(msg)}&owner=${encodeURIComponent(myEmail)}`;

            emailjs.send("service_ip92c2u", "template_rq2ywdn", {
                to_email: email2, from_name: n1, to_name: n2, message: msg, link: pLink
            }).then(() => showPage('p-waiting'));
        }

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('partner') === 'true') {
                document.getElementById('name1').value = params.get('n1');
                document.getElementById('name2').value = params.get('n2');
                document.getElementById('proposal-display').innerText = params.get('msg');
                document.getElementById('partner-heading').innerText = `For ${params.get('n2')}`;
                showPage('p5');
            }
        };

        function partnerAccepts() {
            const params = new URLSearchParams(window.location.search);
            const ownerEmail = params.get('owner');
            const partnerVows = document.getElementById('vows').value;

            document.getElementById('final-names').innerText = `${params.get('n1')} & ${params.get('n2')}`;
            document.getElementById('final-vows').innerText = document.getElementById('proposalMsg').value || partnerVows;
            document.getElementById('sig-label-1').innerText = params.get('n1');
            document.getElementById('sig-label-2').innerText = params.get('n2');
            
            showPage('p6');
        }

        async function download() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            
            const cert = document.getElementById('cert-wrap');
            cert.style.display = 'block';

            // Essential: Wait for browser to actually paint the Base64 images
            await new Promise(r => setTimeout(r, 1000));

            html2canvas(cert, { 
                scale: 2, 
                useCORS: true, 
                logging: false,
                backgroundColor: "#fffcf9"
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Marriage_License.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                
                cert.style.display = 'none';
                overlay.style.display = 'none';
            });
        }
    </script>
</body>
</html>